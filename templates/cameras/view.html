{% extends 'base.html' %}
{% block content %}
<h1 class="text-xl font-bold mb-4">{{ camera.name }}</h1>
<img src="{{ url_for('cameras.video_feed', camera_id=camera.id) }}" width="720" />

<h2 class="text-lg font-bold mt-4">Recent Scans</h2>
<table class="table-auto w-full border mt-2">
  <tr class="bg-gray-200">
    <th class="px-2 py-1">Code</th>
    <th class="px-2 py-1">Timestamp</th>
  </tr>
  {% for scan in scans %}
  <tr class="border-t">
    <td class="px-2 py-1">{{ scan.code }}</td>
    <td class="px-2 py-1">{{ scan.timestamp }}</td>
  </tr>
  {% endfor %}
</table>

<script>
  const cameraId = {{ camera.id }};
  let lastTs = {{ last_timestamp }};

  function start() {
    fetch(`/cameras/${cameraId}/start_scan`, {method: 'POST'});
  }

  function stop() {
    fetch(`/cameras/${cameraId}/stop_scan`, {method: 'POST', keepalive: true});
  }

  function checkForScans() {
    fetch(`{{ url_for('cameras.last_scan_timestamp') }}`)
      .then(r => r.json())
      .then(data => {
        if (data.timestamp > lastTs) {
          lastTs = data.timestamp;
          document.body.classList.add('scan-success');
          setTimeout(() => {
            document.body.classList.remove('scan-success');
          }, 1500);
        }
      });
  }

  window.addEventListener('load', () => {
    start();
    setInterval(checkForScans, 1000);
  });
  window.addEventListener('beforeunload', stop);
</script>


{% endblock %}
